(ns components-test.main
  (:require
   ["package:flutter/material.dart" :as m]
   ["package:mongol/mongol.dart" :as mgl]
   [cljd.flutter :as f]
   [components.bottom-sheet :as bottom-sheet]
   [components.chip :as chip]
   [components.expansion-tile :as expansion-tile]
   [components.input-dialog :as input-dialog]
   [components.search-bar :as search-bar]
   [components.select :as select]
   [components.tab-layout :as tab-layout]
   [components.tooltip :as tooltip]))

;; Component list for the home page
(def component-list
  [{:name "Bottom Sheet" :key "bottom_sheet" :icon m/Icons.call_to_action}
   {:name "Chip" :key "chip" :icon m/Icons.label}
   {:name "Expansion Tile" :key "expansion_tile" :icon m/Icons.expand_more}
   {:name "Input Dialog" :key "input_dialog" :icon m/Icons.input}
   {:name "Search Bar" :key "search_bar" :icon m/Icons.search}
   {:name "Select" :key "select" :icon m/Icons.arrow_drop_down}
   {:name "Tab Layout" :key "tab_layout" :icon m/Icons.tab}
   {:name "Tooltip" :key "tooltip" :icon m/Icons.info}])

;; Component card widget
(defn component-card [{:keys [name icon on-tap]}]
  (f/widget
   :get {{{:flds [surfaceVariant onSurfaceVariant primary]} .-colorScheme} m/Theme}
   (m/GestureDetector
    .onTap on-tap
    .child (m/Container
            .margin (m/EdgeInsets.all 8)
            .padding (m/EdgeInsets.all 16)
            .decoration (m/BoxDecoration
                        .color surfaceVariant
                        .borderRadius (m/BorderRadius.circular 12)
                        .border (m/Border.all .color primary .width 1))
            .child (m/Column
                    .mainAxisSize m/MainAxisSize.min
                    .mainAxisAlignment m/MainAxisAlignment.center
                    .children
                    [(m/Icon icon .size 48 .color primary)
                     (m/SizedBox .height 12)
                     (mgl/MongolText
                      name
                      .style (m/TextStyle
                             .fontSize 16
                             .color onSurfaceVariant
                             .fontWeight m/FontWeight.w500))])))))

;; Demo pages for each component
(defn chip-demo-page []
  (let [chip-state (atom {})
        chip1 (chip/filter-chip "chip1" "ᠪᠠᠷᠢᠮᠲᠠ" chip-state)
        chip2 (chip/filter-chip "chip2" "ᠲᠣᠬᠢᠷᠠᠭᠦᠯᠭᠡ" chip-state)
        chip3 (chip/filter-chip "chip3" "ᠪᠢ" chip-state)]
    (f/widget
     (m/Scaffold
      .appBar (m/AppBar .title (m/Text "Chip Demo"))
      .body (m/Padding
             .padding (m/EdgeInsets.all 16)
             .child
             (m/Row
              .crossAxisAlignment m/CrossAxisAlignment.start
              .children
              [(mgl/MongolText "Filter Chips" .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
               (m/SizedBox .width 16)
               (m/Row
                .children
                [chip1 chip2 chip3])]))))))

(defn expansion-tile-demo-page []
  (f/widget
   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Expansion Tile Demo"))
    .body (m/Padding
           .padding (m/EdgeInsets.all 16)
           .child
           (m/SingleChildScrollView
            .scrollDirection m/Axis.horizontal
            .child
            (m/Row
             .crossAxisAlignment m/CrossAxisAlignment.start
             .children
             [(mgl/MongolText "Expansion Tiles" .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
              (m/SizedBox .width 16)
              (expansion-tile/expansion-tile
               {:title (mgl/MongolText "ᠪᠠᠷᠢᠮᠲᠠ")
                :children [(mgl/MongolText "Child content 1")
                           (mgl/MongolText "Child content 2")]})
              (m/SizedBox .width 8)
              (expansion-tile/expansion-tile
               {:title (mgl/MongolText "ᠲᠣᠬᠢᠷᠠᠭᠦᠯᠭᠡ")
                :children [(mgl/MongolText "More content here")]})]))))))

(defn input-dialog-demo-page []
  (f/widget
   :context ctx
   :get [m/Navigator]
   :let [show-dialog (fn []
                       (m/showDialog
                        .context ctx
                        .builder (fn [_] (input-dialog/generic-input-dialog
                                          {:hint "Enter text..."
                                           :on-submit (fn [text] (println "Submitted:" text) (.pop navigator))
                                           :on-result-tap (fn [item controller atom]
                                                            (set! (.-text controller) (:text item))
                                                            (reset! atom (:text item)))}))))]
   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Input Dialog Demo"))
    .body (m/Center
           .child (m/ElevatedButton
                   .onPressed show-dialog
                   .child (m/Text "Open Input Dialog"))))))

(defn search-bar-demo-page []
  (let [search-state (atom "")]
    (f/widget
     (m/Scaffold
      .appBar (m/AppBar .title (m/Text "Search Bar Demo"))
      .body (m/Padding
             .padding (m/EdgeInsets.all 16)
             .child
             (m/Row
              .crossAxisAlignment m/CrossAxisAlignment.start
              .children
              [(mgl/MongolText "Search Bar" .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
               (m/SizedBox .width 16)
               (search-bar/fake-search-bar
                {:state-atom search-state
                 :on-tap (fn [] (println "Search tapped"))})]))))))

(defn select-demo-page []
  (f/widget
   :let [selected-value (atom "option1")
         items [{:value "option1" :label (mgl/MongolText "ᠪᠠᠷᠢᠮᠲᠠ")}
                {:value "option2" :label (mgl/MongolText "ᠲᠣᠬᠢᠷᠠᠭᠦᠯᠭᠡ")}
                {:value "option3" :label (mgl/MongolText "ᠪᠢ")}]]

   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Select Demo"))
    .body (m/Padding
           .padding (m/EdgeInsets.all 16)
           .child
           (m/Row
            .crossAxisAlignment m/CrossAxisAlignment.start
            .children
            [(mgl/MongolText "Mongol Select" .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
             (m/SizedBox .width 16)
             (select/mongol-select
              {:value @selected-value
               :items items
               :on-changed (fn [v] (reset! selected-value v))
               :value-builder (fn [v]
                               (let [selected-label (->> items
                                                         (filter #(= (:value %) v))
                                                         first
                                                         :label)]
                                 (m/Container
                                  .padding (m/EdgeInsets.all 12)
                                  .decoration (m/BoxDecoration
                                              .border (m/Border.all)
                                              .borderRadius (m/BorderRadius.circular 8))
                                  .child selected-label)))})])))))

(defn tab-layout-demo-page []
  (f/widget
   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Tab Layout Demo"))
    .body (tab-layout/sidebar-page
           {:tabs [{:text "ᠨᠢᠢᠷ" :icon m/Icons.home}
                   {:text "ᠠᠩᠭᠢᠯᠠᠯ" :icon m/Icons.category}
                   {:text "ᠪᠢ" :icon m/Icons.person}]
            :contents [(m/Center .child (m/Text "Home Page"))
                       (m/Center .child (m/Text "Category Page"))
                       (m/Center .child (m/Text "Profile Page"))]
            :on-change (fn [idx] (println "Switched to tab:" idx))}))))

(defn tooltip-demo-page []
  (f/widget
   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Tooltip Demo"))
    .body (m/Padding
           .padding (m/EdgeInsets.all 16)
           .child
           (m/Row
            .crossAxisAlignment m/CrossAxisAlignment.start
            .mainAxisAlignment m/MainAxisAlignment.center
            .children
            [(mgl/MongolText "Long press items to see tooltips"
                    .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
             (m/SizedBox .width 32)
             (tooltip/v-overlay-tooltip
              {:message "ᠮᠣᠩᠭᠣᠯ ᠽᠢᠪ"
               :haptic? true
               :child (m/Container
                       .padding (m/EdgeInsets.all 16)
                       .decoration (m/BoxDecoration
                                   .color m/Colors.blue
                                   .borderRadius (m/BorderRadius.circular 8))
                       .child (m/Text "Long press me" .style (m/TextStyle .color m/Colors.white)))})
             (m/SizedBox .width 16)
             (tooltip/v-overlay-tooltip
              {:message "This is another tooltip"
               :child (m/Container
                       .padding (m/EdgeInsets.all 16)
                       .decoration (m/BoxDecoration
                                   .color m/Colors.green
                                   .borderRadius (m/BorderRadius.circular 8))
                       .child (m/Text "Or me" .style (m/TextStyle .color m/Colors.white)))})])))))

(defn bottom-sheet-demo-page []
  (f/widget
   :context ctx
   :let [show-bottom-sheet (fn []
                            (bottom-sheet/bottom-sheet
                             ctx
                             [{:type :header :title "Actions"}
                              {:type :action :title "ᠪᠠᠷᠢᠮᠲᠠ" :icon m/Icons.home :on-tap (fn [] (println "Home tapped"))}
                              {:type :action :title "ᠲᠣᠬᠢᠷᠠᠭᠦᠯᠭᠡ" :icon m/Icons.category :on-tap (fn [] (println "Category tapped"))}
                              {:type :header :title "More"}
                              {:type :action :title "ᠪᠢ" :icon m/Icons.person :on-tap (fn [] (println "Profile tapped"))}
                              {:type :action :title "Settings" :icon m/Icons.settings :on-tap (fn [] (println "Settings tapped"))}]
                             :height-factor 0.5
                             :show-handle? true
                             :layout-mode :scroll))]
   (m/Scaffold
    .appBar (m/AppBar .title (m/Text "Bottom Sheet Demo"))
    .body (m/Center
           .child (m/Column
                   .mainAxisAlignment m/MainAxisAlignment.center
                   .children
                   [(mgl/MongolText "Bottom Sheet Demo"
                           .style (m/TextStyle .fontSize 20 .fontWeight m/FontWeight.bold))
                    (m/SizedBox .height 32)
                    (m/ElevatedButton
                     .onPressed show-bottom-sheet
                     .child (m/Text "Show Bottom Sheet"))
                    (m/SizedBox .height 16)
                    (m/ElevatedButton
                     .onPressed (fn []
                                 (bottom-sheet/bottom-sheet
                                  ctx
                                  [{:type :action :title "Grid Item 1" :icon m/Icons.star :on-tap (fn [] (println "Item 1"))}
                                   {:type :action :title "Grid Item 2" :icon m/Icons.favorite :on-tap (fn [] (println "Item 2"))}
                                   {:type :action :title "Grid Item 3" :icon m/Icons.bookmark :on-tap (fn [] (println "Item 3"))}
                                   {:type :action :title "Grid Item 4" :icon m/Icons.share :on-tap (fn [] (println "Item 4"))}]
                                  :layout-mode :grid))
                     .child (m/Text "Show Grid Bottom Sheet"))])))))

;; Route generator
(defn get-demo-page [component-key]
  (case component-key
    "bottom_sheet" bottom-sheet-demo-page
    "chip" chip-demo-page
    "expansion_tile" expansion-tile-demo-page
    "input_dialog" input-dialog-demo-page
    "search_bar" search-bar-demo-page
    "select" select-demo-page
    "tab_layout" tab-layout-demo-page
    "tooltip" tooltip-demo-page
    (fn [] (m/Scaffold .appBar (m/AppBar .title (m/Text "Unknown")) .body (m/Text "Unknown component")))))

;; Home page
(defn home-page []
  (f/widget
   :context ctx
   (m/Scaffold
    .appBar (m/AppBar
             .title (m/Text "MGL Components")
             .elevation 0)
    .body (m/SingleChildScrollView
           .scrollDirection m/Axis.horizontal
           .child (m/Row
                   .children
                   (map (fn [{:keys [name key icon]}]
                          (component-card
                           {:name name
                            :icon icon
                            :on-tap (fn []
                                     (.push (m/Navigator.of ctx)
                                            (m/MaterialPageRoute
                                             .builder (fn [_] ((get-demo-page key))))))}))
                        component-list))))))

(defn main []
  (m.WidgetsFlutterBinding/ensureInitialized)
  
  (f/run
   (f/widget
    (m/MaterialApp
     .title "MGL Components Test"
     .debugShowCheckedModeBanner false
     .theme (m/ThemeData
             .brightness m.Brightness/dark
             .useMaterial3 true)
     .home (home-page)
     ;(m/Center .child (m/Text "Hello, World!"))
     ))))
